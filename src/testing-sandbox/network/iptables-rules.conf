# IPtables Rules for Testing Sandbox Isolation
# Purpose: Restrict sandbox network access to only necessary services
#
# Network Architecture:
# - Sandbox Network: 172.28.0.0/16 (cyberagent-test-network)
# - API Gateway: 172.28.0.10
# - Testing Sandbox: 172.28.0.20
# - Allowed Egress: DNS (53), API Gateway (9260), Target networks (dynamic)

# Clear existing rules for sandbox
*filter
:SANDBOX_INPUT - [0:0]
:SANDBOX_OUTPUT - [0:0]
:SANDBOX_FORWARD - [0:0]

# INPUT chain for sandbox
-A SANDBOX_INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A SANDBOX_INPUT -p icmp -j ACCEPT
-A SANDBOX_INPUT -i lo -j ACCEPT
-A SANDBOX_INPUT -p tcp --dport 9260 -j ACCEPT
-A SANDBOX_INPUT -j DROP

# OUTPUT chain for sandbox
-A SANDBOX_OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A SANDBOX_OUTPUT -o lo -j ACCEPT

# Allow DNS
-A SANDBOX_OUTPUT -p udp --dport 53 -j ACCEPT
-A SANDBOX_OUTPUT -p tcp --dport 53 -j ACCEPT

# Allow API Gateway communication
-A SANDBOX_OUTPUT -d 172.28.0.10 -p tcp --dport 9260 -j ACCEPT

# Allow traffic to authorized scan targets (configured dynamically)
# Note: This would be managed by job processor based on target_authorizations table
-A SANDBOX_OUTPUT -m comment --comment "Authorized targets - managed dynamically" -j ACCEPT

# Log and drop everything else
-A SANDBOX_OUTPUT -j LOG --log-prefix "SANDBOX_BLOCKED: " --log-level 4
-A SANDBOX_OUTPUT -j DROP

# FORWARD chain
-A SANDBOX_FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
-A SANDBOX_FORWARD -s 172.28.0.0/16 -j SANDBOX_OUTPUT
-A SANDBOX_FORWARD -d 172.28.0.0/16 -j SANDBOX_INPUT
-A SANDBOX_FORWARD -j DROP

COMMIT

# Rate limiting to prevent abuse
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Rate limit outbound connections (prevent scanning abuse)
-A OUTPUT -s 172.28.0.0/16 -m connlimit --connlimit-above 1000 -j DROP
-A OUTPUT -s 172.28.0.0/16 -m limit --limit 1000/sec -j ACCEPT

COMMIT

# NAT rules (if needed for internet access)
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Masquerade outbound traffic
-A POSTROUTING -s 172.28.0.0/16 ! -d 172.28.0.0/16 -j MASQUERADE

COMMIT
